<!DOCTYPE html>
<html lang="ru">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>KazP • Закладки</title>
	<link rel="stylesheet" href="assets/style.css"/>
</head>
<body>
	<header class="kp-header">
		<div class="kp-container">
			<div class="kp-brand">KazP<span>Team</span></div>
			<nav class="kp-nav">
				<a href="index.php">Главная</a>
				<a href="history.html">История</a>
				<a class="active" href="#">Закладки</a>
				<a href="login.html" id="navLogin">Вход</a>
				<a href="register.html" id="navRegister">Регистрация</a>
				<a href="#" id="navLogout" style="display:none;" onclick="window.kpLogout&&window.kpLogout();return false;">Выйти</a>
			</nav>
		</div>
	</header>
	<main class="kp-container">
		<section class="kp-card">
			<h2>Мои закладки</h2>
			<form id="bmForm" class="kp-row" style="margin-bottom:10px;">
				<input id="bmName" placeholder="Название" required>
				<input id="bmCoords" placeholder="lat,lng" required>
				<button>Добавить</button>
			</form>
			<div id="bmList" class="kp-list" style="grid-template-columns:repeat(2,1fr);"></div>
			<div id="status" class="kp-status" aria-live="polite"></div>
		</section>
	</main>
	<script>
	(function(){
		var list=document.getElementById('bmList'); var statusEl=document.getElementById('status');
		function setStatus(m,e){ statusEl.textContent=m||''; statusEl.style.color=e?'#fda4af':'#94a3b8'; }
		function load(){
			var token=localStorage.getItem('kp_token'); if(!token){ setStatus('Нужен вход',true); return; }
			setStatus('Загрузка…');
			fetch('api.php?route=/api/bookmarks', { headers:{ 'Authorization':'Bearer '+token }})
				.then(function(r){ return r.json(); })
				.then(function(res){
					list.innerHTML='';
					(res.items||[]).forEach(function(b){
						var div=document.createElement('div'); div.className='kp-item';
						div.innerHTML='<div><strong>'+b.name+'</strong></div><div class="meta">'+b.lat+', '+b.lng+' · '+b.created_at+'</div>';
						list.appendChild(div);
					});
					setStatus('');
				})
				.catch(function(){ setStatus('Ошибка загрузки',true); });
		}
		document.getElementById('bmForm').addEventListener('submit', function(e){
			e.preventDefault();
			var token=localStorage.getItem('kp_token'); if(!token){ setStatus('Нужен вход',true); return; }
			var name=document.getElementById('bmName').value.trim(); var coords=document.getElementById('bmCoords').value.trim();
			var m=coords.split(','); if(m.length!==2){ setStatus('Формат координат: lat,lng',true); return; }
			var lat=parseFloat(m[0]); var lng=parseFloat(m[1]); if(!isFinite(lat)||!isFinite(lng)){ setStatus('Некорректные координаты',true); return; }
			setStatus('Сохранение…');
			fetch('api.php?route=/api/bookmarks',{ method:'POST', headers:{ 'Content-Type':'application/json', 'Authorization':'Bearer '+token }, body: JSON.stringify({ name:name, lat:lat, lng:lng }) })
				.then(function(r){ return r.json(); })
				.then(function(){ setStatus('Сохранено'); load(); })
				.catch(function(){ setStatus('Ошибка сохранения',true); });
		});
		load();
	})();
	</script>
	<script src="assets/user.js"></script>
</body>
</html>


